@using Microsoft.AspNetCore.SignalR.Client;

@page "/contacts"

@inject IContactsClient ContactsClient
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Contacts</PageTitle>

<MudText Typo="Typo.h3" Align="Align.Center" GutterBottom="true" Class="mt-4 mb-8">Contacts</MudText>

@* <MudButton Variant="Variant.Filled" OnClick="NewContact" Class="mb-2">New transaction</MudButton> *@

<MudTable T="ContactDto" @ref="table" ServerData="ServerReload" Hover="true" Elevation="1" Breakpoint="Breakpoint.Sm"
    Loading="@loading" LoadingProgressColor="Color.Info" >
    
     <HeaderContent>
         <MudTh>First Name</MudTh>
         <MudTh>Last Name</MudTh>
         <MudTh>SSN</MudTh>
         <MudTh>Phone</MudTh>
         <MudTh>Phone (Mobile)</MudTh>
         <MudTh>Email</MudTh>
         <MudTh>Address</MudTh>
     </HeaderContent>
     <RowTemplate Context="contact">
         <MudTd DataLabel="FirstName">@contact.FirstName</MudTd>
         <MudTd DataLabel="LastName">@contact.LastName</MudTd>
         <MudTd DataLabel="SSN">@contact.Ssn</MudTd>
         <MudTd DataLabel="Phone">@contact.Phone</MudTd>
         <MudTd DataLabel="Phone (Mobile)">@contact.PhoneMobile</MudTd>
         <MudTd DataLabel="Email">@contact.Email</MudTd>
         <MudTd DataLabel="Address">
            @contact.Address?.Thoroughfare @contact.Address?.SubPremises, @contact.Address?.Premises @contact.Address?.PostalCode @contact.Address?.Locality @contact.Address?.SubAdministrativeArea @contact.Address?.AdministrativeArea @contact.Address?.Country</MudTd>
     </RowTemplate>
    <LoadingContent>
        <MudText>Loading...</MudText>
    </LoadingContent>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code
{
    MudTable<ContactDto> table = null!;
    bool loading = false;

    private async Task<TableData<ContactDto>> ServerReload(TableState state)
    {
        loading = true;

        try
        {
            var result = await ContactsClient.GetContacts2Async(state.Page, state.PageSize);

            return new TableData<ContactDto>() { TotalItems = result.TotalItems, Items = result.Items };
        }
        finally
        {
            loading = false;
        }
    }

    private TableData<ContactDto>? GetTableData()
    {
        return (TableData<ContactDto>?)table?.GetType()?
            .GetField("_server_data", System.Reflection.BindingFlags.NonPublic |
                         System.Reflection.BindingFlags.Instance)?
            .GetValue(table);
    }
}