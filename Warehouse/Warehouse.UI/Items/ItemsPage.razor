@page "/warehouse/items"
@attribute [Authorize]
@inject IItemsClient ItemsClient
@inject NavigationManager NavigationManager
@inject IDialogService DialogService

<MudText Typo="Typo.h3" Class="mb-4">Items</MudText>

<MudButton Variant="Variant.Filled" OnClick="async () => await OnItemClicked(null)" StartIcon="@Icons.Filled.Add" Color="Color.Default" Class="mb-2 me-2">
    New Item
</MudButton>

<MudPaper Class="pa-4" Elevation="25">
    <MudTable @ref="table" T="ItemDto" Elevation="0" ServerData="LoadData" Dense="false" Hover="true" Bordered="false"
              Striped="true" OnRowClick="ItemOnClick">
        <ToolBarContent>

            <MudSpacer />

            <MudTextField T="string" Dense="true" Value="searchString" ValueChanged="@(s=>OnSearch(s))" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Immediate="true" DebounceInterval="200"></MudTextField>
        </ToolBarContent>
       <HeaderContent>
            <MudTh>Id</MudTh>
            <MudTh>SKU</MudTh>
            <MudTh>Name</MudTh>
            <MudTh>Qt on hand</MudTh>
            <MudTh>Qt picked</MudTh>
            <MudTh>Qt reserved</MudTh>
            <MudTh>Qt available</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate Context="item">
            <MudTd DataLabel="Id">@item.Id</MudTd>
            <MudTd DataLabel="SKU">@item.Sku</MudTd>
            <MudTd DataLabel="Name">@item.Name</MudTd>
            <MudTd DataLabel="Qt on hand">@item.QuantityOnHand <MudIconButton Size="Size.Small" Icon="@Icons.Filled.Edit" OnClick="async () => OnItemAdjustQuantityOnHand(item)" /></MudTd>
            <MudTd DataLabel="Qt on hand">@item.QuantityPicked <MudIconButton Size="Size.Small" Icon="@Icons.Filled.Edit" OnClick="async () => OnPickItems(item)" /></MudTd>
            <MudTd DataLabel="Qt on hand">@item.QuantityReserved <MudIconButton Size="Size.Small" Icon="@Icons.Filled.Edit" OnClick="async () => OnReserveItems(item)" /></MudTd>
            <MudTd DataLabel="Qt on hand">@item.QuantityAvailable</MudTd>
            <MudTd>
                <MudIconButton Size="Size.Small" Icon="@Icons.Filled.LocalShipping" OnClick="async () => OnShipItems(item)" />
                <MudIconButton Size="Size.Small" Icon="@Icons.Filled.CallReceived" OnClick="async () => OnReceiveItems(item)" />
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
</MudPaper>


@code {
    MudTable<ItemDto> table; 
    string? searchString;

    public ItemDto Item { get; set; }

    private async Task<TableData<ItemDto>> LoadData(TableState state)
    {
        try
        {
            var results = await ItemsClient.GetItems2Async(state.Page + 1, state.PageSize, searchString, state.SortDirection == MudBlazor.SortDirection.None ? null : state.SortLabel, state.SortDirection == MudBlazor.SortDirection.None ? null : (state.SortDirection == MudBlazor.SortDirection.Ascending ? YourBrand.Warehouse.Client.SortDirection.Asc : YourBrand.Warehouse.Client.SortDirection.Desc));
            return new TableData<ItemDto> { Items = results.Items, TotalItems = results.TotalItems };
        }
        /*catch (ApiException exc)
        {
        }
        catch (HttpRequestException exc)
        {
        }*/
        catch (Exception exc)
        {
            //await JSHelpers.Alert(exc.Message);
        }

        return null!;
    }

    private async Task ItemOnClick(TableRowClickEventArgs<ItemDto> ev)
    {
        var item = ev.Item;

        await OnItemClicked(item);
    }

    private void OnSearch(string text)
    {
        searchString = text;
        table.ReloadServerData();
    }

    private async Task OnItemChanged(ItemDto sa)
    {
        Item = sa;
        table.ReloadServerData();
    }

    async Task OnItemClicked(ItemDto? dto)
    {
        try
        {
            var parameters = new DialogParameters();
            parameters.Add(nameof(ItemDialog.ItemId), dto?.Id);

            var dialogReference = DialogService.Show<ItemDialog>(dto is null ? "New Item" : $"Update {dto.Name}", parameters, new DialogOptions {
                //FullScreen = true,
                MaxWidth = MaxWidth.ExtraLarge
            });
            var result = await dialogReference.Result;

            if(result.Cancelled)
                return;

            await table.ReloadServerData();
        }
        catch (AccessTokenNotAvailableException exception)
        {
            exception.Redirect();
        }
    }

    async Task OnItemAdjustQuantityOnHand(ItemDto? dto)
    {
        try
        {
            var parameters = new DialogParameters();
            parameters.Add(nameof(ItemDialog.ItemId), dto?.Id);

            var dialogReference = DialogService.Show<AdjustQuantityOnHandDialog>("Adjust Quantity on Hand", parameters, new DialogOptions {
                MaxWidth = MaxWidth.ExtraLarge
            });
            var result = await dialogReference.Result;

            if(result.Cancelled)
                return;

           var tableData = GetTableData();
           var item = tableData.Items.First(x => x.Id == dto.Id);

           var item2 = await ItemsClient.GetItemAsync(dto.Id);

            item.QuantityAvailable = item2.QuantityAvailable;
            item.QuantityOnHand = item2.QuantityOnHand;
            item.QuantityPicked = item2.QuantityPicked;
            item.QuantityReserved = item2.QuantityReserved;

            StateHasChanged();
        }
        catch (AccessTokenNotAvailableException exception)
        {
            exception.Redirect();
        }
    }

    async Task OnPickItems(ItemDto? dto)
    {
        try
        {
            var parameters = new DialogParameters();
            parameters.Add(nameof(ItemDialog.ItemId), dto?.Id);

            var dialogReference = DialogService.Show<PickItemsDialog>("Pick items", parameters, new DialogOptions {
                MaxWidth = MaxWidth.ExtraLarge
            });
            var result = await dialogReference.Result;

            if(result.Cancelled)
                return;

           var tableData = GetTableData();
           var item = tableData.Items.First(x => x.Id == dto.Id);

           var item2 = await ItemsClient.GetItemAsync(dto.Id);

            item.QuantityAvailable = item2.QuantityAvailable;
            item.QuantityOnHand = item2.QuantityOnHand;
            item.QuantityPicked = item2.QuantityPicked;
            item.QuantityReserved = item2.QuantityReserved;

            StateHasChanged();
        }
        catch (AccessTokenNotAvailableException exception)
        {
            exception.Redirect();
        }
    }

    async Task OnReserveItems(ItemDto? dto)
    {
        try
        {
            var parameters = new DialogParameters();
            parameters.Add(nameof(ItemDialog.ItemId), dto?.Id);

            var dialogReference = DialogService.Show<ReserveItemsDialog>("Reserve items", parameters, new DialogOptions {
                MaxWidth = MaxWidth.ExtraLarge
            });
            var result = await dialogReference.Result;

            if(result.Cancelled)
                return;

           var tableData = GetTableData();
           var item = tableData.Items.First(x => x.Id == dto.Id);

           var item2 = await ItemsClient.GetItemAsync(dto.Id);

            item.QuantityAvailable = item2.QuantityAvailable;
            item.QuantityOnHand = item2.QuantityOnHand;
            item.QuantityPicked = item2.QuantityPicked;
            item.QuantityReserved = item2.QuantityReserved;

            StateHasChanged();
        }
        catch (AccessTokenNotAvailableException exception)
        {
            exception.Redirect();
        }
    }

    async Task OnShipItems(ItemDto? dto)
    {
        try
        {
            var parameters = new DialogParameters();
            parameters.Add(nameof(ItemDialog.ItemId), dto?.Id);

            var dialogReference = DialogService.Show<ShipItemsDialog>("Ship items", parameters, new DialogOptions {
                MaxWidth = MaxWidth.ExtraLarge
            });
            var result = await dialogReference.Result;

            if(result.Cancelled)
                return;

           var tableData = GetTableData();
           var item = tableData.Items.First(x => x.Id == dto.Id);

           var item2 = await ItemsClient.GetItemAsync(dto.Id);

            item.QuantityAvailable = item2.QuantityAvailable;
            item.QuantityOnHand = item2.QuantityOnHand;
            item.QuantityPicked = item2.QuantityPicked;
            item.QuantityReserved = item2.QuantityReserved;

            StateHasChanged();
        }
        catch (AccessTokenNotAvailableException exception)
        {
            exception.Redirect();
        }
    }

    async Task OnReceiveItems(ItemDto? dto)
    {
        try
        {
            var parameters = new DialogParameters();
            parameters.Add(nameof(ItemDialog.ItemId), dto?.Id);

            var dialogReference = DialogService.Show<ReceiveItemsDialog>("Receive items", parameters, new DialogOptions {
                MaxWidth = MaxWidth.ExtraLarge
            });
            var result = await dialogReference.Result;

            if(result.Cancelled)
                return;

           var tableData = GetTableData();
           var item = tableData.Items.First(x => x.Id == dto.Id);

           var item2 = await ItemsClient.GetItemAsync(dto.Id);

            item.QuantityAvailable = item2.QuantityAvailable;
            item.QuantityOnHand = item2.QuantityOnHand;
            item.QuantityPicked = item2.QuantityPicked;
            item.QuantityReserved = item2.QuantityReserved;

            StateHasChanged();
        }
        catch (AccessTokenNotAvailableException exception)
        {
            exception.Redirect();
        }
    }

    private TableData<ItemDto>? GetTableData()
    {
        return (TableData<ItemDto>?)table?.GetType()?
            .GetField("_server_data", System.Reflection.BindingFlags.NonPublic |
                         System.Reflection.BindingFlags.Instance)?
            .GetValue(table);
    }
}